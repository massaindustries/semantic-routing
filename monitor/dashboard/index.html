<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Time Logging Monitor</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #1a1a2e; color: #eee; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        header { background: #16213e; padding: 20px; border-radius: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        h1 { color: #e94560; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: #16213e; padding: 20px; border-radius: 10px; text-align: center; }
        .stat-value { font-size: 2em; font-weight: bold; color: #e94560; }
        .stat-label { color: #888; margin-top: 5px; }
        .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .chart-card { background: #16213e; padding: 20px; border-radius: 10px; }
        .chart-title { margin-bottom: 15px; color: #e94560; }
        .table-container { background: #16213e; border-radius: 10px; overflow: hidden; margin-bottom: 20px; }
        .table-header { padding: 15px 20px; background: #0f3460; display: flex; justify-content: space-between; align-items: center; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #0f3460; }
        th { background: #0f3460; color: #e94560; }
        tr:hover { background: #1f4068; }
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.85em; }
        .status-success { background: #28a745; color: white; }
        .status-error { background: #dc3545; color: white; }
        .phase-badge { padding: 4px 10px; border-radius: 5px; font-size: 0.85em; background: #0f3460; color: #e94560; }
        .bar-chart { display: flex; flex-direction: column; gap: 10px; }
        .bar-item { display: flex; align-items: center; gap: 10px; }
        .bar-label { width: 150px; font-size: 0.9em; }
        .bar-track { flex: 1; background: #0f3460; border-radius: 5px; height: 25px; overflow: hidden; }
        .bar-fill { background: #e94560; height: 100%; transition: width 0.3s; display: flex; align-items: center; justify-content: flex-end; padding-right: 10px; font-size: 0.85em; }
        .bar-value { width: 80px; text-align: right; font-size: 0.9em; }
        .filters { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .filter-group { display: flex; flex-direction: column; gap: 5px; }
        label { font-size: 0.85em; color: #888; }
        input, select { padding: 8px 12px; border-radius: 5px; border: 1px solid #0f3460; background: #16213e; color: #eee; }
        button { padding: 8px 20px; border-radius: 5px; border: none; background: #e94560; color: white; cursor: pointer; }
        button:hover { opacity: 0.9; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab { padding: 10px 20px; background: #16213e; border-radius: 5px; cursor: pointer; }
        .tab.active { background: #e94560; }
        .timeline { display: flex; flex-direction: column; gap: 5px; }
        .timeline-item { display: flex; align-items: center; gap: 15px; padding: 10px; background: #0f3460; border-radius: 5px; }
        .timeline-phase { width: 150px; font-weight: bold; color: #e94560; }
        .timeline-time { width: 100px; color: #888; }
        .timeline-bar { flex: 1; background: #1a1a2e; height: 20px; border-radius: 3px; overflow: hidden; }
        .timeline-fill { background: #28a745; height: 100%; }
        .error-detail { color: #dc3545; font-size: 0.85em; margin-top: 5px; }
        .refresh-info { font-size: 0.85em; color: #888; }
        .hidden { display: none; }
        .no-data { text-align: center; padding: 40px; color: #888; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div>
                <h1>Time Logging Monitor</h1>
                <p class="refresh-info">Aggiornato: <span id="lastUpdate">-</span></p>
            </div>
            <div>
                <button onclick="refreshAll()">Aggiorna</button>
            </div>
        </header>

        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="stat-value" id="totalRequests">-</div>
                <div class="stat-label">Richieste Totali</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgDuration">-</div>
                <div class="stat-label">Durata Media (ms)</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="successRate">-</div>
                <div class="stat-label">Tasso Successo (%)</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalErrors">-</div>
                <div class="stat-label">Errori</div>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="showTab('phases')">Fasi</div>
            <div class="tab" onclick="showTab('requests')">Richieste</div>
            <div class="tab" onclick="showTab('errors')">Errori</div>
            <div class="tab" onclick="showTab('distribution')">Distribuzione</div>
        </div>

        <div id="phasesTab" class="tab-content">
            <div class="charts-grid">
                <div class="chart-card">
                    <h3 class="chart-title">Tempo Medio per Fase</h3>
                    <div class="bar-chart" id="phaseChart"></div>
                </div>
                <div class="chart-card">
                    <h3 class="chart-title">Conteggio per Fase</h3>
                    <div class="bar-chart" id="phaseCountChart"></div>
                </div>
            </div>
        </div>

        <div id="requestsTab" class="tab-content hidden">
            <div class="filters">
                <div class="filter-group">
                    <label>Modality</label>
                    <select id="modalityFilter" onchange="filterRequests()">
                        <option value="">Tutti</option>
                        <option value="text">Text</option>
                        <option value="image">Image</option>
                        <option value="audio">Audio</option>
                        <option value="text+image">Text+Image</option>
                        <option value="text+audio">Text+Audio</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Model</label>
                    <select id="modelFilter" onchange="filterRequests()">
                        <option value="">Tutti</option>
                    </select>
                </div>
            </div>
            <div class="table-container">
                <div class="table-header">
                    <h3>Richieste Recenti</h3>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Request ID</th>
                            <th>Timestamp</th>
                            <th>Modality</th>
                            <th>Model</th>
                            <th>Phase</th>
                            <th>Duration</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="requestsTable"></tbody>
                </table>
            </div>
        </div>

        <div id="errorsTab" class="tab-content hidden">
            <div class="table-container">
                <div class="table-header">
                    <h3>Errori Recenti</h3>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Request ID</th>
                            <th>Timestamp</th>
                            <th>Phase</th>
                            <th>Error Type</th>
                            <th>Message</th>
                        </tr>
                    </thead>
                    <tbody id="errorsTable"></tbody>
                </table>
            </div>
        </div>

        <div id="distributionTab" class="tab-content hidden">
            <div class="charts-grid">
                <div class="chart-card">
                    <h3 class="chart-title">Distribuzione per Modality</h3>
                    <div class="bar-chart" id="modalityChart"></div>
                </div>
                <div class="chart-card">
                    <h3 class="chart-title">Distribuzione per Model</h3>
                    <div class="bar-chart" id="modelChart"></div>
                </div>
            </div>
            <div class="chart-card">
                <h3 class="chart-title">Richieste per Giorno</h3>
                <div class="bar-chart" id="dailyChart"></div>
            </div>
        </div>

        <div id="timelineModal" class="modal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);justify-content:center;align-items:center;z-index:1000;">
            <div style="background:#16213e;padding:30px;border-radius:10px;max-width:800px;width:90%;max-height:80vh;overflow-y:auto;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                    <h2 style="color:#e94560;">Timeline Request</h2>
                    <button onclick="closeModal()">X</button>
                </div>
                <div id="timelineContent"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let allRequests = [];
        let allStats = null;

        async function fetchAPI(endpoint) {
            try {
                const res = await fetch(`${API_BASE}${endpoint}`);
                if (!res.ok) throw new Error('API error');
                return await res.json();
            } catch (e) {
                console.error('Fetch error:', e);
                return null;
            }
        }

        async function refreshAll() {
            allStats = await fetchAPI('/stats');
            allRequests = await fetchAPI('/requests?limit=100');
            const errors = await fetchAPI('/errors?limit=20');
            const modalityDist = await fetchAPI('/distribution/modality');
            const modelDist = await fetchAPI('/distribution/model');
            const dailyStats = await fetchAPI('/stats/daily?days=7');
            const phases = await fetchAPI('/phases');

            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
            updateStatsCards(allStats);
            renderPhaseCharts(allStats);
            renderRequestsTable(allRequests);
            renderErrorsTable(errors);
            renderDistributionCharts(modalityDist, modelDist);
            renderDailyChart(dailyStats);
            populateModelFilter(allRequests);
        }

        function updateStatsCards(stats) {
            document.getElementById('totalRequests').textContent = stats.total_requests || 0;
            document.getElementById('avgDuration').textContent = (stats.avg_total_duration_ms || 0).toFixed(0);
            document.getElementById('successRate').textContent = calculateSuccessRate(stats);
            document.getElementById('totalErrors').textContent = countErrors(stats);
        }

        function calculateSuccessRate(stats) {
            if (!stats.phases) return 0;
            const total = stats.phases.find(p => p.phase === 'total_request');
            return total && total.success_rate !== undefined ? total.success_rate.toFixed(1) : '100.0';
        }

        function countErrors(stats) {
            if (!stats.phases) return 0;
            const total = stats.phases.find(p => p.phase === 'total_request');
            if (!total || !total.count) return 0;
            const successRate = total.success_rate !== undefined ? total.success_rate : 100;
            return Math.round(total.count * (100 - successRate) / 100);
        }

        function renderPhaseCharts(stats) {
            const phases = (stats.phases || []).filter(p => p.phase !== 'total_request');
            const maxDuration = Math.max(...phases.map(p => p.avg_duration_ms), 1);

            document.getElementById('phaseChart').innerHTML = phases.map(p => `
                <div class="bar-item">
                    <div class="bar-label">${p.phase}</div>
                    <div class="bar-track">
                        <div class="bar-fill" style="width: ${(p.avg_duration_ms / maxDuration) * 100}%">
                            ${p.avg_duration_ms.toFixed(0)}ms
                        </div>
                    </div>
                </div>
            `).join('');

            const maxCount = Math.max(...phases.map(p => p.count), 1);
            document.getElementById('phaseCountChart').innerHTML = phases.map(p => `
                <div class="bar-item">
                    <div class="bar-label">${p.phase}</div>
                    <div class="bar-track">
                        <div class="bar-fill" style="width: ${(p.count / maxCount) * 100}%">
                            ${p.count}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderRequestsTable(requests) {
            allRequests = requests || [];
            filterRequests();
        }

        function filterRequests() {
            const modality = document.getElementById('modalityFilter').value;
            const model = document.getElementById('modelFilter').value;
            let filtered = allRequests;

            if (modality) {
                filtered = filtered.filter(r => r.modality === modality);
            }
            if (model) {
                filtered = filtered.filter(r => r.model === model);
            }

            document.getElementById('requestsTable').innerHTML = filtered.slice(0, 50).map(r => `
                <tr onclick="showTimeline('${r.request_id}')" style="cursor:pointer;">
                    <td>${r.request_id}</td>
                    <td>${new Date(r.timestamp).toLocaleString()}</td>
                    <td><span class="phase-badge">${r.modality || '-'}</span></td>
                    <td>${r.model || '-'}</td>
                    <td>${r.phase || '-'}</td>
                    <td>${(r.duration_ms || 0).toFixed(0)}ms</td>
                    <td><span class="status-badge ${r.success ? 'status-success' : 'status-error'}">
                        ${r.success ? 'OK' : 'ERR'}
                    </span></td>
                </tr>
            `).join('') || '<tr><td colspan="7" class="no-data">Nessuna richiesta</td></tr>';
        }

        function renderErrorsTable(errors) {
            document.getElementById('errorsTable').innerHTML = (errors || []).map(e => `
                <tr onclick="showTimeline('${e.request_id}')" style="cursor:pointer;">
                    <td>${e.request_id}</td>
                    <td>${new Date(e.timestamp).toLocaleString()}</td>
                    <td>${e.phase || '-'}</td>
                    <td><span class="status-badge status-error">${e.error_type || '-'}</span></td>
                    <td class="error-detail">${(e.error_message || '').substring(0, 100)}</td>
                </tr>
            `).join('') || '<tr><td colspan="5" class="no-data">Nessun errore</td></tr>';
        }

        function renderDistributionCharts(modalityDist, modelDist) {
            const maxModality = Math.max(...Object.values(modalityDist || {}), 1);
            document.getElementById('modalityChart').innerHTML = Object.entries(modalityDist || {}).map(([k, v]) => `
                <div class="bar-item">
                    <div class="bar-label">${k}</div>
                    <div class="bar-track">
                        <div class="bar-fill" style="width: ${(v / maxModality) * 100}%">
                            ${v}
                        </div>
                    </div>
                </div>
            `).join('') || '<div class="no-data">Nessun dato</div>';

            const maxModel = Math.max(...Object.values(modelDist || {}), 1);
            document.getElementById('modelChart').innerHTML = Object.entries(modelDist || {}).map(([k, v]) => `
                <div class="bar-item">
                    <div class="bar-label">${k}</div>
                    <div class="bar-track">
                        <div class="bar-fill" style="width: ${(v / maxModel) * 100}%">
                            ${v}
                        </div>
                    </div>
                </div>
            `).join('') || '<div class="no-data">Nessun dato</div>';
        }

        function renderDailyChart(dailyStats) {
            const maxRequests = Math.max(...(dailyStats || []).map(d => d.requests), 1);
            document.getElementById('dailyChart').innerHTML = (dailyStats || []).reverse().map(d => `
                <div class="bar-item">
                    <div class="bar-label">${d.date}</div>
                    <div class="bar-track">
                        <div class="bar-fill" style="width: ${(d.requests / maxRequests) * 100}%">
                            ${d.requests}
                        </div>
                    </div>
                    <div class="bar-value">${d.avg_duration_ms.toFixed(0)}ms avg</div>
                </div>
            `).join('') || '<div class="no-data">Nessun dato</div>';
        }

        function populateModelFilter(requests) {
            const models = [...new Set((requests || []).map(r => r.model).filter(Boolean))];
            const select = document.getElementById('modelFilter');
            select.innerHTML = '<option value="">Tutti</option>' + models.map(m =>
                `<option value="${m}">${m}</option>`
            ).join('');
        }

        async function showTimeline(requestId) {
            const timeline = await fetchAPI(`/requests/${requestId}/timeline`);
            if (!timeline || timeline.length === 0) {
                alert('Timeline non disponibile');
                return;
            }
            const maxDuration = Math.max(...timeline.map(t => t.duration_ms || 0), 1);
            document.getElementById('timelineContent').innerHTML = `
                <p style="margin-bottom:15px;"><strong>Request ID:</strong> ${requestId}</p>
                <div class="timeline">
                    ${timeline.map(t => `
                        <div class="timeline-item">
                            <div class="timeline-phase">${t.phase}</div>
                            <div class="timeline-time">${(t.duration_ms || 0).toFixed(1)}ms</div>
                            <div class="timeline-bar">
                                <div class="timeline-fill" style="width: ${((t.duration_ms || 0) / maxDuration) * 100}%"></div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            document.getElementById('timelineModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('timelineModal').style.display = 'none';
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(tabName + 'Tab').classList.remove('hidden');
            event.target.classList.add('active');
        }

        document.addEventListener('DOMContentLoaded', refreshAll);
        setInterval(refreshAll, 30000);
    </script>
</body>
</html>
